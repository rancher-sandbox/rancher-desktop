# Signing Releases

Normally, we build artifacts via GitHub Actions as zip files, which can then be
signed offline.  This is necessary as the relevant certificates are not
available online during CI.

In general, the process involves:

1. Download the zip archive from GitHub.

   **Note** The archive will be a zip within a zip.  Extract one level to get
   the file as generated by electron-builder.

2. Set up the signing environment; see the platform-specific sections below.

3. Run the signing tool:

    ```sh
    npm run sign -- path/to/archive.zip
    ```

4. Look in `dist/` for the signed files (`Rancher Desktop Setup.exe`, etc.).

## Windows

On Windows, it is necessary to obtain a code signing certificate that can be
used with the Windows infrastructure.  It is then necessary to determine the
fingerprint of the certificate, and set it as the `CSC_FINGERPRINT` environment
variable before running `npm run sign`.

### Generate a Test Certificate

For testing purposes, we can generate a certificate locally by running the
following command in PowerShell:

```powershell
New-SelfSignedCertificate `
    -Type Custom `
    -Subject "CN=Rancher-Sandbox, C=CA" `
    -KeyUsage DigitalSignature `
    -CertStoreLocation Cert:\CurrentUser\My `
    -FriendlyName "Rancher-Sandbox Code Signing" `
    -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
```

This will display the new certificate, with a `Thumbprint` column; this is the
certificate fingerprint that we will need to set as `CSC_FINGERPRINT`.  If you
need to refer to the certificate later, it can be obtained by running
`ls Cert:\CurrentUser\My` in a PowerShell prompt.

### Using a Certificate Stored on a YubiKey

If you have a certificate (with private key) that is stored on a YubiKey device,
it is first necessary to install the [YubiKey Minidriver].  After plugging in
your device, you should then be able to run `certutil -scinfo -silent` to locate
the fingerprint for your desired certificate.  Note that this will list all the
certificates on the device, including the chain to your certificate, and you
must search the output for your signing certificate and locate the
`Cert Hash(sha1):` entry.  That hash is then used for `CSC_FINGERPRINT` above.

[YubiKey Minidriver]: https://www.yubico.com/support/download/smart-card-drivers-tools/
